<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Property Details â€“ Hostel Hunt</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    /* Keeping your EXACT CSS */
    body { background:#f3f4f6; margin:0; font-family:Arial, sans-serif; }
    header { background:#1e3a8a; color:#fff; padding:14px 20px; display:flex; justify-content:space-between; }
    header a { color:white; text-decoration:none; margin-left:10px; }
    .container { max-width:900px; margin:30px auto; padding:16px; }
    .card { background:#fff; padding:20px; border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,0.08); }
    .property-img { width:100%; height:320px; object-fit:cover; border-radius:12px; background:#eee; }
    .price { color:#16a34a; font-size:20px; font-weight:700; margin-top:8px; }
    .label { font-weight:600; margin-top:14px; display:block; color:#555; }
    #map { height:300px; width:100%; border-radius:10px; margin-top:10px; z-index:1; }
    .payment-section { margin-top:25px; border-top:1px solid #eee; padding-top:20px; display:none; background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px dashed #2563eb; }
    .qr-img { width:150px; height:150px; border:1px solid #ccc; padding:5px; margin:10px 0; background:white; }
    .upi-badge { background:#e0f2fe; color:#0369a1; font-family:monospace; padding:4px 8px; border-radius:4px; font-weight:bold; font-size: 14px; }
    .pay-now-link { background: #2563eb; color: white; padding: 10px 25px; border-radius: 25px; text-decoration: none; font-weight: bold; display: inline-block; margin: 10px 0; box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2); transition: transform 0.2s; }
    .pay-now-link:hover { transform: scale(1.05); background: #1d4ed8; }
    .confirm-btn { background:#16a34a; color:white; padding:12px 20px; border-radius:6px; border:none; font-size:16px; cursor:pointer; margin-top:10px; width:100%; font-weight:bold; }
    .confirm-btn:hover { background:#15803d; }
    .confirm-btn:disabled { background:#ccc; cursor:not-allowed; }
    #loading { text-align:center; padding:50px; }
  </style>
</head>

<body>

<header>
  <div><strong>Hostel Hunt</strong></div>
  <nav>
    <a href="index.html">Home</a>
  </nav>
</header>

<div class="container">
  <div id="loading">Loading details...</div>

  <div class="card" id="propertyContent" style="display:none;">
    <img id="propImg" class="property-img" src="">
    <h2 id="title" style="margin-bottom:5px;"></h2>
    <div class="price" id="rent"></div>
    
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:10px;">
       <div>
         <span class="label">Type</span> <span id="type"></span>
         <span class="label">Gender</span> <span id="gender"></span>
         <span class="label">City</span> <span id="city"></span>
       </div>
       <div>
         <span class="label">College</span> <span id="college"></span>
         <span class="label">Beds Available</span> <span id="beds"></span>
       </div>
    </div>

    <span class="label">Full Address</span>
    <div id="address"></div>
    <span class="label">Facilities</span>
    <div id="facilities"></div>
    <span class="label">Location Map</span>
    <div id="map"></div>

    <div id="paymentSection" class="payment-section">
        <h3 style="margin-top:0; color:#1e3a8a; text-align:center;">Book This Property</h3>
        <div style="text-align:center; margin-bottom:15px;">
            <p style="margin:0; font-size:14px; color:#555;">Option 1: Scan QR or Click Button</p>
            <img id="qrCode" class="qr-img">
            <div><span id="upiId" class="upi-badge"></span></div>
            <a id="payNowLink" href="#" class="pay-now-link">âš¡ Pay Now (UPI App)</a>
        </div>
        <hr style="border:0; border-top:1px solid #ddd; margin: 15px 0;">
        <div style="text-align:center;">
          <p style="margin:0; font-size:14px; color:#555; text-align:left;">Option 2: Confirm Booking</p>
          <input type="text" id="utrInput" placeholder="Enter Transaction ID / UTR (Required)" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; margin-top:8px; box-sizing:border-box;">
          <button id="confirmPayBtn" class="confirm-btn">Confirm Booking</button>
          <p id="payMsg" style="margin-top:10px; font-weight:bold;"></p>
        </div>
    </div>

    <div id="cashSection" class="payment-section" style="display:none; text-align:center;">
        <h3 style="margin-top:0; color:#444;">Cash Payment Only</h3>
        <p>Online payment is not available for this property.</p>
        <button id="bookCashBtn" class="confirm-btn" style="background:#2563eb;">Request Booking (Pay at Location)</button>
    </div>

    <div style="margin-top:20px; text-align:center;">
       <a href="#" id="chatBtn" style="color:#2563eb; font-weight:bold; text-decoration:none;">Chat with Owner</a>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
  import { auth, db } from "./firebase.js"; 
  import { doc, getDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  let currentUser = null;
  let propertyData = null;
  let propId = null;

  onAuthStateChanged(auth, (u) => { currentUser = u; loadProperty(); });

  async function loadProperty() {
    propId = new URLSearchParams(window.location.search).get("id");
    if (!propId) { alert("No property ID found"); return; }
    try {
        const snap = await getDoc(doc(db, "properties", propId));
        if (!snap.exists()) { document.getElementById("loading").textContent = "Property not found."; return; }
        
        propertyData = snap.data();
        document.getElementById("title").textContent = propertyData.title || "";
        document.getElementById("rent").textContent = "â‚¹" + (propertyData.rent || 0);
        document.getElementById("type").textContent = propertyData.type || "-";
        document.getElementById("gender").textContent = propertyData.forGender || "-";
        document.getElementById("city").textContent = propertyData.city || "-";
        document.getElementById("college").textContent = propertyData.nearbyCollege || "-";
        document.getElementById("address").textContent = propertyData.address || "-";
        document.getElementById("beds").textContent = propertyData.availableBeds || "0";
        document.getElementById("facilities").textContent = propertyData.facilities || "-";
        
        const img = propertyData.photoURL || propertyData.imageBase64 || "";
        if(img) document.getElementById("propImg").src = img;

        if(propertyData.paymentMode !== 'cash_only' && propertyData.upiId) {
            document.getElementById("paymentSection").style.display = "block";
            document.getElementById("upiId").textContent = propertyData.upiId;
            const upiLink = `upi://pay?pa=${propertyData.upiId}&pn=HostelOwner&cu=INR`;
            document.getElementById("qrCode").src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(upiLink)}`;
            document.getElementById("payNowLink").href = upiLink;
        } else {
            document.getElementById("cashSection").style.display = "block";
        }

        const mapLat = propertyData.lat || 20.296;
        const mapLng = propertyData.lng || 85.824;
        const map = L.map('map').setView([mapLat, mapLng], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        L.marker([mapLat, mapLng]).addTo(map);

        document.getElementById("loading").style.display = "none";
        document.getElementById("propertyContent").style.display = "block";
        map.invalidateSize();

        document.getElementById("chatBtn").onclick = (e) => {
            e.preventDefault();
            if(!currentUser) location.href="login.html";
            else location.href = `chat.html?ownerId=${propertyData.ownerId}&propertyId=${propId}`;
        };
    } catch(err) { console.error(err); alert("Error loading property."); }
  }

  // --- HIDDEN COMMISSION LOGIC HERE ---
  async function submitBooking(isCash) {
      if(!currentUser) { alert("Please login to book."); location.href="login.html"; return; }

      let transactionId = "CASH_REQUEST";
      if (!isCash) {
          const utr = document.getElementById("utrInput").value.trim();
          if(utr.length < 4) { alert("Please enter Transaction ID (UTR)."); return; }
          transactionId = utr;
      }
      
      const btn = isCash ? document.getElementById("bookCashBtn") : document.getElementById("confirmPayBtn");
      btn.textContent = "Processing..."; btn.disabled = true;

      try {
          const rent = Number(propertyData.rent) || 0;
          const commission = Math.ceil(rent * 0.03); // ðŸ”¥ 3% Logic

          await addDoc(collection(db, "bookings"), {
              propertyId: propId,
              propertyTitle: propertyData.title,
              ownerId: propertyData.ownerId,
              ownerName: propertyData.ownerName || "Owner",
              studentId: currentUser.uid,
              studentEmail: currentUser.email,
              transactionId: transactionId,
              paymentType: isCash ? "cash" : "online",
              status: "pending",
              amount: rent,
              platformCommission: commission, // ðŸ”¥ Saving Commission
              commissionPaid: false,
              createdAt: serverTimestamp()
          });

          alert("Booking request sent successfully!");
          btn.textContent = "Request Sent";
      } catch(e) { 
          alert("Error: " + e.message);
          btn.disabled = false; btn.textContent = "Try Again";
      }
  }

  document.getElementById("confirmPayBtn").onclick = () => submitBooking(false);
  document.getElementById("bookCashBtn").onclick = () => submitBooking(true);
</script>
</body>
</html>
