<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Edit Property â€“ Hostel Hunt</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">

  <style>
    body { background:#f3f4f6; font-family:Arial; margin:0; }
    .container { max-width:900px; margin:30px auto; padding:16px; }
    .card { background:#fff; padding:20px; border-radius:12px; }
    label { font-weight:600; display:block; margin-top:12px; }
    input, select, textarea {
      width:100%; padding:10px; border-radius:8px;
      border:1px solid #d1d5db;
    }
    textarea { min-height:80px; }
    img { width:100%; max-height:260px; object-fit:cover; border-radius:8px; margin-top:10px; display:none; }
    .btn { margin-top:12px; padding:10px 14px; border-radius:8px; border:none; cursor:pointer; }
    .btn-save { background:#16a34a; color:#fff; }
    .btn-upload { background:#2563eb; color:#fff; }
    .btn-danger { background:#ef4444; color:#fff; }
  </style>
</head>

<body>

<header>
  <div class="logo">Hostel Hunt</div>
  <nav style="display:flex;gap:12px;">
    <a href="index.html">Home</a>
    <a href="owner_dashboard.html">Owner Dashboard</a>
  </nav>
</header>

<div class="container">
  <div class="card">
    <h2>Edit Property</h2>

    <form id="editForm">

      <label>Title</label>
      <input id="title" required>

      <label>Type</label>
      <select id="type">
        <option value="hostel">Hostel</option>
        <option value="pg">PG</option>
        <option value="room">Room</option>
        <option value="flat">Flat</option>
      </select>

      <label>For Gender</label>
      <select id="gender">
        <option value="male">Male</option>
        <option value="female">Female</option>
        <option value="both">Both</option>
      </select>

      <label>City</label>
      <input id="city" required>

      <label>Nearby College</label>
      <input id="nearbyCollege">

      <label>Address</label>
      <textarea id="address"></textarea>

      <label>Rent</label>
      <input type="number" id="rent">

      <label>Available Beds</label>
      <input type="number" id="beds">

      <label>Facilities</label>
      <input id="facilities">

      <label>Property Image (max 200KB)</label>
      <img id="preview">

      <input type="file" id="imageInput" accept="image/*">
      <button type="button" id="removeImage" class="btn btn-danger" style="display:none;">Remove Image</button>

      <button class="btn btn-save" type="submit">Save Changes</button>
      <p id="msg"></p>
    </form>
  </div>
</div>

<script type="module">
  import { auth, db } from "./firebase.js";
  import {
    doc, getDoc, updateDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { onAuthStateChanged }
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const q = new URLSearchParams(location.search);
  const propertyId = q.get("id");

  if (!propertyId) location.href = "owner_dashboard.html";

  const title = document.getElementById("title");
  const type = document.getElementById("type");
  const gender = document.getElementById("gender");
  const city = document.getElementById("city");
  const nearbyCollege = document.getElementById("nearbyCollege");
  const address = document.getElementById("address");
  const rent = document.getElementById("rent");
  const beds = document.getElementById("beds");
  const facilities = document.getElementById("facilities");

  const imageInput = document.getElementById("imageInput");
  const preview = document.getElementById("preview");
  const removeBtn = document.getElementById("removeImage");
  const msg = document.getElementById("msg");

  let imageBase64 = "";
  let removeImage = false;

  onAuthStateChanged(auth, async (user) => {
    if (!user) return location.href = "login.html";

    const snap = await getDoc(doc(db, "properties", propertyId));
    if (!snap.exists()) return alert("Property not found");

    const p = snap.data();
    if (p.ownerId !== user.uid) return alert("Unauthorized");

    title.value = p.title || "";
    type.value = p.type || "hostel";
    gender.value = p.forGender || "both";
    city.value = p.city || "";
    nearbyCollege.value = p.nearbyCollege || "";
    address.value = p.address || "";
    rent.value = p.rent || "";
    beds.value = p.availableBeds || "";
    facilities.value = p.facilities || "";

    if (p.imageBase64) {
      imageBase64 = p.imageBase64;
      preview.src = imageBase64;
      preview.style.display = "block";
      removeBtn.style.display = "inline-block";
    }
  });

  imageInput.onchange = () => {
    const file = imageInput.files[0];
    if (!file) return;

    if (file.size > 200 * 1024) {
      alert("Image must be under 200KB");
      imageInput.value = "";
      return;
    }

    const reader = new FileReader();
    reader.onload = () => {
      imageBase64 = reader.result;
      preview.src = imageBase64;
      preview.style.display = "block";
      removeBtn.style.display = "inline-block";
      removeImage = false;
    };
    reader.readAsDataURL(file);
  };

  removeBtn.onclick = () => {
    imageBase64 = "";
    removeImage = true;
    preview.style.display = "none";
    imageInput.value = "";
    removeBtn.style.display = "none";
  };

  document.getElementById("editForm").onsubmit = async (e) => {
    e.preventDefault();
    msg.textContent = "Saving...";

    const updates = {
      title: title.value,
      type: type.value,
      forGender: gender.value,
      city: city.value,
      nearbyCollege: nearbyCollege.value,
      address: address.value,
      rent: Number(rent.value),
      availableBeds: beds.value ? Number(beds.value) : null,
      facilities: facilities.value,
      updatedAt: serverTimestamp()
    };

    if (removeImage) updates.imageBase64 = "";
    else if (imageBase64) updates.imageBase64 = imageBase64;

    await updateDoc(doc(db, "properties", propertyId), updates);

    msg.style.color = "green";
    msg.textContent = "Property updated!";
    setTimeout(() => location.href = "owner-dashboard.html", 800);
  };
</script>

</body>
</html>
