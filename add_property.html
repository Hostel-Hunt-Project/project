<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Add Property – Hostel Hunt</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />

  <style>
    body { background:#f3f4f6; margin:0; font-family:Arial, sans-serif; }
    header { background:#1e3a8a; color:#fff; padding:14px 20px; display:flex; justify-content:space-between; align-items:center; }
    header a { color:white; margin-left:10px; text-decoration:none; }
    .form-container { max-width:800px; margin:40px auto; background:white; padding:25px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); }
    .form-group { margin-bottom:14px; }
    label { font-weight:600; display:block; margin-bottom:6px; }
    input, select, textarea { width:100%; padding:10px; border-radius:6px; border:1px solid #d1d5db; font-size:15px; }
    textarea { height:80px; resize:none; }
    .image-preview { width:100%; max-height:250px; object-fit:cover; border-radius:8px; margin-bottom:10px; display:none; background:#eee; }
    .btn-upload { background:#2563eb; color:white; padding:8px 12px; border-radius:6px; cursor:pointer; display:inline-block; }
    button[type="submit"] { background:#2563eb; color:white; padding:10px 16px; border-radius:8px; border:none; cursor:pointer; font-size:16px; margin-top:10px; }
  </style>
</head>

<body>

<header>
  <div class="logo">Hostel Hunt</div>
  <nav id="mainNav" style="display:flex;align-items:center;gap:12px;">
    <a href="index.html">Home</a>
    <a href="owner-dashboard.html">Dashboard</a>

    <a href="login.html" id="loginNav">Login</a>
    <a href="register.html" id="signupNav">Sign up</a>

    <a href="profile.html" id="meProfileLink" style="display:none;align-items:center;gap:8px;">
      <img id="navAvatar" src="https://via.placeholder.com/36"
           style="width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid #fff;">
      <span id="navName" style="font-weight:600;"></span>
    </a>

    <a href="#" id="logoutNav"
       style="display:none;color:#fff;background:#ef4444;padding:6px 10px;border-radius:6px;text-decoration:none;">
       Logout
    </a>
  </nav>
</header>

<div class="form-container">
  <h2>Add New Property</h2>

  <form id="propertyForm">

    <div class="form-group">
      <label>Property Title</label>
      <input type="text" id="title" required />
    </div>

    <div class="form-group">
      <label>Property Type</label>
      <select id="type">
        <option value="hostel">Hostel</option>
        <option value="pg">PG</option>
        <option value="room">Room</option>
        <option value="flat">Flat</option>
      </select>
    </div>

    <div class="form-group">
      <label>For Gender</label>
      <select id="gender">
        <option value="male">Male</option>
        <option value="female">Female</option>
        <option value="both">Both</option>
      </select>
    </div>

    <div class="form-group">
      <label>City</label>
      <input type="text" id="city" required />
    </div>

    <div class="form-group">
      <label>Nearby College</label>
      <input type="text" id="nearbyCollege" />
    </div>

    <div class="form-group">
      <label>Full Address</label>
      <textarea id="address" required></textarea>
    </div>

    <div class="form-group">
      <label>Monthly Rent (₹)</label>
      <input type="number" id="rent" required />
    </div>

    <div class="form-group">
      <label>Available Beds</label>
      <input type="number" id="availableBeds" />
    </div>

    <div class="form-group">
      <label>Facilities</label>
      <input type="text" id="facilities" placeholder="WiFi, Food, Laundry" />
    </div>

    <!-- IMAGE -->
    <img id="imagePreview" class="image-preview" />

    <label class="btn-upload">
      Choose Image (max 150KB)
      <input type="file" id="propertyImage" accept="image/*" hidden />
    </label>

    <button type="submit">Save Property</button>
    <p id="message" style="margin-top:10px;"></p>

  </form>
</div>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { onAuthStateChanged, signOut } from
    "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { collection, addDoc, serverTimestamp, doc, getDoc }
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // HEADER
  const loginNav = document.getElementById("loginNav");
  const signupNav = document.getElementById("signupNav");
  const logoutNav = document.getElementById("logoutNav");
  const meProfileLink = document.getElementById("meProfileLink");
  const navAvatar = document.getElementById("navAvatar");
  const navName = document.getElementById("navName");

  let currentUser = null;
  let propertyImageBase64 = null;

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      location.href = "login.html";
      return;
    }

    currentUser = user;
    loginNav.style.display = "none";
    signupNav.style.display = "none";
    logoutNav.style.display = "";
    meProfileLink.style.display = "flex";

    const snap = await getDoc(doc(db, "users", user.uid));
    if (snap.exists()) {
      const d = snap.data();
      navName.textContent = d.name || user.email.split("@")[0];
      navAvatar.src = d.photoBase64 || "https://via.placeholder.com/36";
    }
  });

  logoutNav.onclick = async () => {
    await signOut(auth);
    location.href = "login.html";
  };

  // IMAGE → BASE64
  const imageInput = document.getElementById("propertyImage");
  const imagePreview = document.getElementById("imagePreview");

  imageInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;

    if (file.size > 150 * 1024) {
      alert("Image must be under 150KB");
      e.target.value = "";
      return;
    }

    const reader = new FileReader();
    reader.onload = () => {
      propertyImageBase64 = reader.result;
      imagePreview.src = propertyImageBase64;
      imagePreview.style.display = "block";
    };
    reader.readAsDataURL(file);
  });

  // SAVE PROPERTY
  document.getElementById("propertyForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    if (!propertyImageBase64) {
      alert("Please select an image");
      return;
    }

    const data = {
      ownerId: currentUser.uid,
      title: document.getElementById("title").value,
      type: document.getElementById("type").value,
      forGender: document.getElementById("gender").value,
      city: document.getElementById("city").value,
      nearbyCollege: document.getElementById("nearbyCollege").value || "",
      address: document.getElementById("address").value,
      rent: Number(document.getElementById("rent").value),
      availableBeds: Number(document.getElementById("availableBeds").value) || null,
      facilities: document.getElementById("facilities").value,
      imageBase64: propertyImageBase64,
      createdAt: serverTimestamp(),
      status: "active"
    };

    await addDoc(collection(db, "properties"), data);

    document.getElementById("message").textContent = "Property added successfully!";
    e.target.reset();
    imagePreview.style.display = "none";
  });
</script>

</body>
</html>
