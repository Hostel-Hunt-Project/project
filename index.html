<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hostel Hunt – Find Hostel & PG</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>

<header>
  <div class="logo">Hostel Hunt</div>

  <nav id="mainNav" style="display:flex;align-items:center;gap:12px;">
    <a href="index.html">Home</a>

    <!-- Messages hidden by default -->
    <a href="inbox.html" id="messagesLink" style="display:none;">Messages</a>

    <a href="owner-dashboard.html" id="ownerDashboardLink" style="display:none;">Owner Dashboard</a>
    <a href="admin-dashboard.html" id="adminDashboardLink" style="display:none; color:#fbbf24;">⚡ Admin</a>

    <a href="login.html" id="loginNav">Login</a>
    <a href="register.html" id="signupNav" class="btn">Sign up</a>

    <a href="profile.html" id="meProfileLink" style="display:none;align-items:center;gap:8px;text-decoration:none;">
      <img id="navAvatar" src="https://via.placeholder.com/36" style="width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid #fff;">
      <span id="navName" style="font-weight:600;"></span>
    </a>

    <a href="#" id="logoutNav" style="display:none;color:#fff;background:#ef4444;padding:6px 10px;border-radius:6px;">Logout</a>
  </nav>
</header>

<section class="hero">
  <div class="hero-left">
    <span class="badge">For Students & Bachelors</span>

    <h1>Find the best Hostel, PG or Room near your college</h1>
    <p>
      Search location-wise hostels, PGs and rooms with filters for gender,
      budget and facilities. Directly connect with verified owners.
    </p>

    <div class="search-box">
      <form id="searchForm">
        <div class="search-row">
          <div>
            <label>City / Area</label>
            <input type="text" id="locationInput" placeholder="e.g. Bhubaneswar, Khandagiri">
          </div>
          <div>
            <label>Near College</label>
            <input type="text" id="collegeInput" placeholder="College / University name">
          </div>
        </div>

        <div class="search-row">
          <div>
            <label>Type</label>
            <select id="typeInput">
              <option value="">Any</option>
              <option value="hostel">Hostel</option>
              <option value="pg">PG</option>
              <option value="room">Room</option>
              <option value="flat">Flat</option>
            </select>
          </div>
          <div>
            <label>For</label>
            <select id="genderInput">
              <option value="">Male / Female / Both</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="both">Both</option>
            </select>
          </div>
          <div>
            <label>Max Budget (per month)</label>
            <input type="number" id="maxRentInput" placeholder="6000">
          </div>
        </div>

        <div style="margin-top:10px;">
          <label>Facilities (comma separated)</label>
          <input type="text" id="facilitiesInput" placeholder="e.g. Wi-Fi, Laundry, CCTV">
        </div>

        <div style="margin-top:12px;">
          <button type="submit" class="btn-primary">Search</button>
          <button type="button" id="clearBtn" class="btn" style="margin-left:8px;">Clear</button>
        </div>
      </form>
    </div>

    <p style="font-size:13px;color:#555;">
      Tip: Login to get personalised recommendations based on your college.
    </p>
  </div>

  <div class="hero-right">
    <img src="https://images.pexels.com/photos/439391/pexels-photo-439391.jpeg" style="width:100%;border-radius:14px;">
  </div>
</section>

<section class="section">
  <h2>Search Results</h2>
  <div class="card-grid" id="featuredList"></div>
  <p id="resultsMessage" style="text-align:center;margin-top:12px;color:#555;"></p>
</section>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { collection, query, getDocs, orderBy, limit, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const loginNav = document.getElementById("loginNav");
  const signupNav = document.getElementById("signupNav");
  const logoutNav = document.getElementById("logoutNav");
  const meProfileLink = document.getElementById("meProfileLink");
  const navAvatar = document.getElementById("navAvatar");
  const navName = document.getElementById("navName");

  const ownerLink = document.getElementById("ownerDashboardLink");
  const adminLink = document.getElementById("adminDashboardLink");
  const messagesLink = document.getElementById("messagesLink");

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      loginNav.style.display = "";
      signupNav.style.display = "";
      logoutNav.style.display = "none";
      meProfileLink.style.display = "none";

      ownerLink.style.display = "none";
      adminLink.style.display = "none";
      messagesLink.style.display = "none"; // hide messages

      return;
    }

    // user is logged in (normal / owner / admin)
    loginNav.style.display = "none";
    signupNav.style.display = "none";
    logoutNav.style.display = "";
    meProfileLink.style.display = "flex";
    messagesLink.style.display = "inline-block"; // NORMAL USER ALSO CAN SEE

    ownerLink.style.display = "none";
    adminLink.style.display = "none";

    const snap = await getDoc(doc(db, "users", user.uid));
    if (snap.exists()) {
      const u = snap.data();
      navName.textContent = u.name || user.email.split("@")[0];
      navAvatar.src = u.photoBase64 || u.photoURL || navAvatar.src;

      if (u.role === "owner") {
        ownerLink.style.display = "inline-block";
      }

      if (u.role === "admin") {
        adminLink.style.display = "inline-block";
        ownerLink.style.display = "inline-block";
      }
    }
  });

  logoutNav.onclick = async () => {
    await signOut(auth);
    location.href = "login.html";
  };

  function createCard(p) {
    const img = p.imageBase64 || p.photoURL || "https://via.placeholder.com/300";
    return `
      <div class="property-card" onclick="window.location.href='property.html?id=${p.id}'" style="cursor:pointer;">
        <img src="${img}">
        <div class="property-content">
          <div class="property-title">${p.title}</div>
          <div class="property-meta">${p.city} ${p.nearbyCollege ? "• " + p.nearbyCollege : ""}</div>
          <div class="price">₹${p.rent}</div>
          <button class="btn-primary" style="margin-top:10px; width:100%;">View Details</button>
        </div>
      </div>
    `;
  }

  async function runSearch() {
    const list = document.getElementById("featuredList");
    const msg = document.getElementById("resultsMessage");
    const loc = document.getElementById("locationInput").value.trim().toLowerCase();

    list.innerHTML = "";
    if (!loc) { msg.textContent = "Please enter a city."; return; }
    msg.textContent = "Searching...";

    const q = query(collection(db, "properties"), orderBy("createdAt", "desc"), limit(50));
    const snap = await getDocs(q);
    const results = [];

    snap.forEach(d => {
      const p = d.data(); p.id = d.id;
      if (p.city?.toLowerCase().includes(loc) && p.status === "active") results.push(p);
    });

    if (!results.length) { msg.textContent = "No properties found."; return; }
    msg.textContent = "";
    list.innerHTML = results.map(createCard).join("");
  }

  document.getElementById("searchForm").onsubmit = (e) => { e.preventDefault(); runSearch(); };
  document.getElementById("clearBtn").onclick = () => {
    document.getElementById("searchForm").reset();
    document.getElementById("featuredList").innerHTML = "";
  };
</script>

</body>
</html>
