<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Owner Dashboard – Hostel Hunt</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">

  <style>
    body { background:#f3f4f6; margin:0; font-family:Arial,sans-serif; }
    header { background:#1e3a8a; color:#fff; padding:14px 20px; display:flex; justify-content:space-between; align-items:center; }
    header a { color:#fff; text-decoration:none; margin-left:12px; }

    .container { max-width:1100px; margin:30px auto; padding:0 16px; }
    .top-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }

    .btn { background:#2563eb; color:#fff; padding:8px 12px; border-radius:6px; text-decoration:none; }
    .card-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:16px; }

    .property-card { background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 2px 5px rgba(0,0,0,0.08); }
    .card-img { width:100%; height:160px; object-fit:cover; }
    .card-body { padding:12px; }
    .actions { padding:10px; border-top:1px solid #eee; display:flex; justify-content:space-between; }
    
    .booking-list { background:#fff; padding:15px; border-radius:12px; margin-bottom:20px; box-shadow:0 2px 5px rgba(0,0,0,0.08); display:none; }
    .booking-item { border-bottom:1px solid #eee; padding:10px 0; display:flex; justify-content:space-between; align-items:center; }
    .booking-item:last-child { border-bottom:none; }
    .btn-small { font-size:12px; padding:5px 10px; cursor:pointer; border:none; border-radius:4px; color:white; margin-left:5px; }
  </style>
</head>

<body>

<header>
  <div><strong>Hostel Hunt</strong></div>
  <div style="display:flex; align-items:center;">
    <span id="ownerName" style="margin-right:15px; font-weight:bold;">Owner</span>
    
    <a href="inbox.html" style="margin-right:15px;">Messages</a>
    <a href="profile.html" style="margin-right:15px;">Profile</a>
    
    <a href="#" id="logoutBtn" style="opacity:0.8;">Logout</a>
  </div>
</header>

<div class="container">
  
  <div id="bookingSection" class="booking-list">
      <h3 style="margin-top:0;">Booking Requests</h3>
      <div id="bookingItems">Loading...</div>
  </div>

  <div class="top-bar">
    <h3>My Properties</h3>
    <a href="add_property.html" class="btn">Add New</a>
  </div>

  <div id="propertyList" class="card-grid">Loading properties...</div>
</div>

<script type="module">
  import { auth, db } from "./firebase.js"; 
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { collection, query, where, getDocs, deleteDoc, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  onAuthStateChanged(auth, async (user) => {
    if (!user) { location.href = "login.html"; return; }
    const snap = await getDoc(doc(db, "users", user.uid));
    if(snap.exists()) {
        document.getElementById("ownerName").textContent = snap.data().name || "Owner";
        loadProperties(user.uid);
        loadBookings(user.uid);
    }
  });

  async function loadBookings(uid) {
      const q = query(collection(db, "bookings"), where("ownerId", "==", uid), where("status", "==", "pending"));
      const snap = await getDocs(q);
      const div = document.getElementById("bookingSection");
      const list = document.getElementById("bookingItems");

      if(snap.empty) { div.style.display="none"; return; }
      
      div.style.display="block";
      list.innerHTML = "";
      
      snap.forEach(d => {
          const b = d.data();
          list.innerHTML += `
            <div class="booking-item" id="book-${d.id}">
               <div>
                 <strong>${b.propertyTitle}</strong> - <small>${b.studentEmail}</small><br>
                 UTR: <span style="font-family:monospace; background:#eee; padding:2px;">${b.transactionId}</span>
               </div>
               <div>
                 <button class="btn-small" style="background:#16a34a;" onclick="window.updateBooking('${d.id}', 'confirmed')">Verify</button>
                 <button class="btn-small" style="background:#ef4444;" onclick="window.updateBooking('${d.id}', 'rejected')">Reject</button>
               </div>
            </div>`;
      });
  }

  window.updateBooking = async (id, status) => {
      if(!confirm("Confirm action?")) return;
      await updateDoc(doc(db, "bookings", id), { status });
      document.getElementById(`book-${id}`).remove();
  };

  async function loadProperties(uid) {
    const q = query(collection(db, "properties"), where("ownerId", "==", uid));
    const snap = await getDocs(q);
    const list = document.getElementById("propertyList");
    list.innerHTML = "";
    
    if(snap.empty) { list.innerHTML = "<p>No properties found.</p>"; return; }

    snap.forEach(docSnap => {
      const p = docSnap.data();
      const img = p.photoURL || p.imageBase64 || "";
      list.innerHTML += `
        <div class="property-card" id="card-${docSnap.id}">
          <img src="${img}" class="card-img">
          <div class="card-body">
            <strong>${p.title}</strong>
            <div style="color:#16a34a; font-weight:bold;">₹${p.rent}</div>
            <div style="font-size:12px; margin-top:5px;">${p.city}</div>
          </div>
          <div class="actions">
            <a href="edit_property.html?id=${docSnap.id}" style="color:#2563eb; text-decoration:none;">Edit</a>
            <a href="property.html?id=${docSnap.id}" style="color:#2563eb; text-decoration:none;">View</a>
            <button onclick="window.deleteProp('${docSnap.id}')" style="color:#ef4444; background:none; border:none; cursor:pointer;">Delete</button>
          </div>
        </div>`;
    });
  }

  window.deleteProp = async (id) => {
      if(confirm("Delete?")) {
          await deleteDoc(doc(db, "properties", id));
          document.getElementById(`card-${id}`).remove();
      }
  };

  document.getElementById("logoutBtn").onclick = async () => { await signOut(auth); location.href="login.html"; };
</script>

</body>
</html>
